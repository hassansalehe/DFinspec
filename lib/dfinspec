#!/usr/bin/env bash

# Copyright (c) 2017, Hassan Salehe Matar
# All rights reserved.
#
# This file is part of DFinspec. For details, see
# https://github.com/hassansalehe/DFinspec.
#

HOME=`pwd`
BIN_DIR=$HOME/bin
OPENMP_DIR=$BIN_DIR

# The usage function, details how to use this tool
Usage() {
  echo "Usage:"
  echo "  $ dfinspec <option> <source_code_file> <gcc/clang_compiler_parameters>"
  echo "    e.g. dfinspec --openmp src/tests/parallel.c -g"
  echo ""
  echo "   <option> can be one of the follwing:"
  echo ""
  echo "   --help"
  echo "   prints this help message."
  echo ""
  echo "   --tests"
  echo "   for detecting nondeterminism in OpenMP tests found in src/tests."
  echo ""
  echo "   --openmp"
  echo "   for detecting nondeterminism in OpenMP programs."
  echo ""
}

if [ $# -eq 0 ]; then
  # Error: no arguments
  Usage
  exit 1
elif [ $1 == "--help" ]; then
  # User needs help message
  Usage
  exit 0
elif [ $1 == "--openmp" ]; then

  shift

  clang++ -Xclang -load -Xclang ${BIN_DIR}/libOpenMPInstrumentPass.so	\
      -g -Wall -O0 -I${OPENMP_DIR}/include -L${OPENMP_DIR}/lib		\
      -Wl,--rpath,${OPENMP_DIR}/lib -fopenmp --std=c++11 -pthread "$@"	\
      -L${BIN_DIR} -lOpenmpCallbacks -pthread

elif [ $1 == "--tests" ]; then

  # Compile the tests found in src/tests
  FILES=($(egrep -l "main.*(.*)" src/tests/*.c))

  for file in "${FILES[@]}"; do
    echo -e "\033[1;32mTranslating $file\033[m"
    execbin="$(basename "$file").exe"

    clang++ -Xclang -load -Xclang ${BIN_DIR}/libOpenMPInstrumentPass.so	\
       -g -Wall -O0 -I${OPENMP_DIR}/include -L${OPENMP_DIR}/lib        	\
       -Wl,--rpath,${OPENMP_DIR}/lib -fopenmp --std=c++11 $file  	\
       -L${BIN_DIR} -lOpenmpCallbacks -pthread -o ./$execbin
#######################################################################
#    clang -Xclang -load -Xclang ./build/libClanompPass.so \
#       -I./src/include -g -Wall -O0 -fopenmp --std=c11    \
#       -pthread $file -o build/bin/$execbin

     echo
     ./$execbin # execute the compiled program
     echo
  done
else
  echo "Unknown arguments"
  Usage
fi
